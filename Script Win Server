#!/bin/bash
# =========================================================
# SMENU WINDOWS
# =========================================================

# 1. Funcion de Validacion de IP (Ahora bloquea IPs que empiezan con 0, 127 y 224+)
validar_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]]; then
        local primer_octeto=$(echo $ip | cut -d. -f1)
        
        # Filtros de seguridad (Igual que en Windows)
        if [ "$primer_octeto" -eq 0 ] || [ "$primer_octeto" -eq 127 ] || [ "$primer_octeto" -ge 224 ]; then
            echo -e "\e[31m[!] La IP $ip es reservada o invalida para DHCP.\e[0m"
            return 1
        fi
        return 0
    else
        return 1
    fi
}

validar_segmento_orden() {
    local red1=$(echo $1 | cut -d. -f1-3)
    local red2=$(echo $2 | cut -d. -f1-3)
    local host1=$(echo $1 | cut -d. -f4)
    local host2=$(echo $2 | cut -d. -f4)

    [ "$red1" != "$red2" ] && echo -e "\e[31m[ERROR] Segmentos diferentes.\e[0m" && return 1
    [ "$host1" -ge "$host2" ] && echo -e "\e[31m[ERROR] Orden de IPs incorrecto.\e[0m" && return 1
    return 0
}

# --- MENU PRINCIPAL ---
while true; do
    echo -e "\n========================================"
    echo "    MENU GESTION DHCP (LINUX - ENS34)"
    echo "========================================"
    echo "1) Verificar Instalacion"
    echo "2) Instalacion / Configurar (Segura)"
    echo "3) Monitoreo (Ver IPs Asignadas)"
    echo "4) Borrar / Desinstalar (Limpieza)"
    echo "5) Salir"
    read -p "Elija una opcion: " opcion

    case $opcion in
        1)
            dpkg -l | grep -q isc-dhcp-server && echo -e "\e[32m[INSTALADO]\e[0m" || echo -e "\e[33m[LIMPIO]\e[0m"
            ;;
        2)
            read -p "IP Inicial: " IPI
            read -p "IP Final: " IPF

            if validar_ip $IPI && validar_ip $IPF; then
                if validar_segmento_orden $IPI $IPF; then
                    echo "Configurando ens34..."
                    # (Aqui va el resto de la logica de instalacion que ya tenias)
                    # Forzando la interfaz ens34 y escribiendo dhcpd.conf
                    sudo apt-get update -qq && sudo apt-get install isc-dhcp-server -y -qq
                    sudo bash -c "cat <<EOF > /etc/dhcp/dhcpd.conf
authoritative;
subnet $(echo $IPI | cut -d. -f1-3).0 netmask 255.255.255.0 {
  range $IPI $IPF;
  option routers $(echo $IPI | cut -d. -f1-3).1;
}
EOF"
                    sudo sed -i 's/INTERFACESv4=".*"/INTERFACESv4="ens34"/' /etc/default/isc-dhcp-server
                    sudo systemctl restart isc-dhcp-server
                    echo -e "\e[32mServidor Activo en ens34.\e[0m"
                fi
            fi
            ;;
        3)
            echo "--- LEASES ACTIVOS ---"
            sudo grep "lease" /var/lib/dhcp/dhcpd.leases | sort | uniq
            ;;
        4)
            sudo apt-get purge isc-dhcp-server -y -qq && sudo rm -rf /etc/dhcp
            echo -e "\e[33mServicio eliminado.\e[0m"
            ;;
        5) exit ;;
    esac
done
