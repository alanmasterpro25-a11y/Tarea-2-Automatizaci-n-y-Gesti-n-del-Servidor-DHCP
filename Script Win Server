# Ejecutar como Administrador
function Mostrar-Menu {
    param([string]$titulo)
    Write-Host "`n=== $titulo ===" -ForegroundColor Cyan
}

function Validar-IP {
    param([string]$ip)
    try { [System.Net.IPAddress]::Parse($ip) | Out-Null; return $true }
    catch { return $false }
}

while ($true) {
    Mostrar-Menu "MENU DHCP - SELECCIÓN DE INTERFAZ"
    Write-Host "1) Verificar Instalación"
    Write-Host "2) Configurar Servidor (Elegir Ethernet0 o Ethernet1)"
    Write-Host "3) Monitoreo de Clientes"
    Write-Host "4) Desinstalar y Limpiar Todo"
    Write-Host "5) Salir"
    $opcion = Read-Host "Seleccione una opción"

    switch ($opcion) {
        "1" {
            $check = Get-WindowsFeature -Name DHCP
            if ($check.Installed) { Write-Host "Estado: INSTALADO" -ForegroundColor Green }
            else { Write-Host "Estado: NO INSTALADO" -ForegroundColor Red }
        }

        "2" {
            Write-Host "Instalando DHCP..." -ForegroundColor Yellow
            Install-WindowsFeature -Name DHCP -IncludeManagementTools > $null
            Start-Service DHCPServer -ErrorAction SilentlyContinue

            # --- SELECCIÓN DINÁMICA DE INTERFAZ ---
            Write-Host "`nInterfaces disponibles:" -ForegroundColor Gray
            Get-NetAdapter | Select-Object Name, InterfaceDescription, Status | ft
            $adapterName = Read-Host "Escriba el nombre del adaptador a usar (ej. Ethernet1)"

            # Entrada de Datos
            do {
                $ipServer = Read-Host "IP para este Servidor (ej. 172.16.0.1)"
                $ipFinal = Read-Host "IP Final del rango (ej. 172.16.0.100)"
                
                if ((Validar-IP $ipServer) -and (Validar-IP $ipFinal)) {
                    $baseIP = $ipServer.Substring(0, $ipServer.LastIndexOf('.'))
                    $scopeID = "$baseIP.0"
                    $pass = $true
                } else { Write-Host "IPs inválidas." -ForegroundColor Red; $pass = $false }
            } until ($pass)

            $lease = Read-Host "Segundos de concesión"
            $ipClientesInicio = "$baseIP.$([int]$ipServer.Split('.')[3] + 1)"

            # --- LIMPIEZA FORZADA PARA ELIMINAR EL ERROR NCB ---
            Write-Host "Limpiando conflictos en $adapterName..." -ForegroundColor Yellow
            # Desactivar DHCP cliente en el servidor para que no choque
            Set-NetIPInterface -InterfaceAlias $adapterName -Dhcp Disabled -ErrorAction SilentlyContinue
            # Eliminar TODAS las IPs previas del adaptador elegido
            Get-NetIPAddress -InterfaceAlias $adapterName -AddressFamily IPv4 | Remove-NetIPAddress -Confirm:$false -ErrorAction SilentlyContinue
            
            # Asignar la nueva IP Estática
            New-NetIPAddress -InterfaceAlias $adapterName -IPAddress $ipServer -PrefixLength 24 -ErrorAction SilentlyContinue > $null

            # Configurar Ámbito
            try {
                Get-DhcpServerv4Scope | Remove-DhcpServerv4Scope -Force -ErrorAction SilentlyContinue
                Add-DhcpServerv4Scope -Name "Red_Personalizada" -StartRange $ipClientesInicio -EndRange $ipFinal -SubnetMask 255.255.255.0 -LeaseDuration (New-TimeSpan -Seconds $lease)
                
                Write-Host "`n--- CONFIGURACIÓN EXITOSA EN $adapterName ---" -ForegroundColor Green
                Write-Host "SERVIDOR: $ipServer | CLIENTES DESDE: $ipClientesInicio"
            } catch { Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red }
        }

        "3" {
            Write-Host "Monitoreando concesiones..." -ForegroundColor Yellow
            Get-DhcpServerv4Lease -ScopeId (Get-DhcpServerv4Scope).ScopeId -ErrorAction SilentlyContinue | Select IPAddress, HostName | ft
        }

        "4" {
            Write-Host "Desinstalando y restaurando..." -ForegroundColor DarkYellow
            Uninstall-WindowsFeature -Name DHCP -Remove -IncludeManagementTools > $null
            Write-Host "DHCP eliminado. Recuerde reactivar DHCP en el adaptador manualmente si lo necesita." -ForegroundColor Green
        }

        "5" { exit }
    }
}
