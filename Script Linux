#!/bin/bash

# --- CONFIGURACIÃ“N INICIAL ---
INTERFAZ="ens34"  # AsegÃºrate que esta sea tu tarjeta de red interna
CONF_FILE="/etc/dhcp/dhcpd.conf"
DEFAULTS_FILE="/etc/default/isc-dhcp-server"

# FunciÃ³n para validar formato IP (Regex simple)
validar_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        return 0
    else
        echo "âŒ Error: Formato de IP invÃ¡lido ($ip)"
        return 1
    fi
}

echo "============================================="
echo "   AUTOMATIZACIÃ“N DHCP - PRACTICA 2"
echo "============================================="

# 1. IDEMPOTENCIA: Verificar si estÃ¡ instalado
if dpkg -l | grep -q isc-dhcp-server; then
    echo "El servicio 'isc-dhcp-server' YA estÃ¡ instalado."
else
    echo "El servicio no existe. Instalando..."
    apt-get update -qq
    apt-get install isc-dhcp-server -y
    echo "InstalaciÃ³n completada."
fi

# 2. CONFIGURACIÃ“N DINÃMICA: Pedir datos al usuario
echo ""
echo "--- Ingrese los parÃ¡metros de red ---"

read -p "IP Inicial del rango (ej. 192.168.100.50): " RANGO_INI
validar_ip $RANGO_INI || exit 1

read -p "IP Final del rango   (ej. 192.168.100.150): " RANGO_FIN
validar_ip $RANGO_FIN || exit 1

read -p "Puerta de Enlace     (ej. 192.168.100.1): " GATEWAY
validar_ip $GATEWAY || exit 1

read -p "Servidor DNS         (ej. 8.8.8.8): " DNS_SRV
validar_ip $DNS_SRV || exit 1

read -p "Tiempo de concesiÃ³n (segundos, default 600): " LEASE
LEASE=${LEASE:-600} # Si da enter, usa 600

# 3. ESCRITURA DE CONFIGURACIÃ“N
echo "Generando archivo de configuraciÃ³n en $CONF_FILE..."

# Backup del original
cp $CONF_FILE "$CONF_FILE.bak"

# Escribir nueva config
cat > $CONF_FILE <<EOF
default-lease-time $LEASE;
max-lease-time 7200;
authoritative;

subnet 192.168.100.0 netmask 255.255.255.0 {
    range $RANGO_INI $RANGO_FIN;
    option routers $GATEWAY;
    option domain-name-servers $DNS_SRV;
}
EOF

# Configurar la interfaz de escucha
sed -i "s/INTERFACESv4=\"\"/INTERFACESv4=\"$INTERFAZ\"/" $DEFAULTS_FILE

# 4. MONITOREO Y REINICIO
echo "ðŸ”„ Reiniciando servicio..."
systemctl restart isc-dhcp-server

if systemctl is-active --quiet isc-dhcp-server; then
    echo "ESTADO: SERVICIO ACTIVO Y CORRIENDO"
    echo "--------------------------------------"
    echo "Ãšltimas concesiones (Leases):"
    tail -n 10 /var/lib/dhcp/dhcpd.leases
else
    echo "ERROR: El servicio fallÃ³ al iniciar. Revisa 'journalctl -xe'."
    # Tip: Validador de sintaxis
    dhcpd -t
fi
