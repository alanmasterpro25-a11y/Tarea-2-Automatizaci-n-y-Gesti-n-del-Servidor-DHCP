#!/bin/bash

# Archivo de registro persistente
LOG_HISTORIAL="/var/log/dhcp_gestion_acciones.log"
INTERFAZ="ens34"  # <--- FIJO COMO PEDISTE

# Función para guardar historial
registrar_log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | sudo tee -a "$LOG_HISTORIAL" > /dev/null
}

# 1. Validaciones
validar_ip() {
    [[ $1 =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]] || return 1
}

validar_rango() {
    local r1=$(echo $1 | cut -d. -f1-3); local r2=$(echo $2 | cut -d. -f1-3)
    [ "$r1" == "$r2" ] && [ $(echo $1 | cut -d. -f4) -lt $(echo $2 | cut -d. -f4) ]
}

# 2. Configuración de Red
configurar_red_servidor() {
    local ip=$1
    local iface=$INTERFAZ
    sudo ip addr flush dev $iface
    sudo ip addr add $ip/24 dev $iface
    sudo ip link set $iface up
    registrar_log "IP Estática configurada: $ip en $iface"
}

# 3. Monitoreo INTELIGENTE
monitoreo_activo() {
    echo -e "\e[33mIniciando monitoreo en tiempo real...\e[0m"
    echo -e "\e[33mPresione Enter en cualquier momento para volver al menú\e[0m"
    sleep 2
    
    local leases_file=""
    local posibles_leases=(
        "/var/lib/dhcp/dhcpd.leases"
        "/var/lib/dhcpd/dhcpd.leases"
        "/var/db/dhcpd/dhcpd.leases"
    )
    
    for file in "${posibles_leases[@]}"; do
        if [ -f "$file" ]; then
            leases_file="$file"
            break
        fi
    done
    
    while true; do
        clear
        echo -e "\e[34m=========================================================="
        echo -e "            SISTEMA DE MONITOREO DE RED ACTIVA"
        echo -e "            (Actualización automática cada 3 segundos)"
        echo -e "==========================================================\e[0m"
        echo -e "\e[1mIP CLIENTE\t\tMAC ADDRESS\t\tHOSTNAME\t\tESTADO\e[0m"
        echo "-----------------------------------------------------------------------------------"

        if [ -z "$leases_file" ] || [ ! -f "$leases_file" ]; then
            echo -e "\e[31mERROR: Archivo de concesiones no encontrado\e[0m"
        elif [ ! -s "$leases_file" ]; then
            echo -e "\e[33mEsperando conexiones... (Archivo vacío)\e[0m"
        else
            resultado=$(sudo awk '
                /^lease / { ip = $2 }
                /binding state/ { st = $3; gsub(";","",st); estado_temp = st }
                /hardware ethernet/ { mac = $3; gsub(";","",mac); mac_temp = mac }
                /client-hostname/ { h = $2; gsub("[\";]","",h); host_temp = (h != "") ? h : "Desconocido" }
                /^}/ {
                    if (ip != "") {
                        estado[ip] = estado_temp
                        macs[ip] = mac_temp
                        host[ip] = host_temp
                    }
                    ip = ""; estado_temp = ""; mac_temp = "N/A"; host_temp = "Desconocido"
                }
                END {
                    for (i in estado) {
                        if (estado[i] != "free") {
                            printf "%s\t%s\t%s\tCONECTADO\n", i, macs[i], host[i]
                        }
                    }
                }
            ' "$leases_file")
            
            if [ -z "$resultado" ]; then
                echo -e "\e[33mNo hay clientes conectados actualmente.\e[0m"
                echo -e "\e[90m(Clientes que hicieron release no se muestran)\e[0m"
            else
                echo -e "\n\e[1;32m=== CLIENTES CONECTADOS ===\e[0m"
                echo "$resultado" | sort -u -t $'\t' -k1,1 | while IFS=$'\t' read -r ip mac hostname estado; do
                    printf "\e[32m✓ %-16s %-20s %-20s %s\e[0m\n" "$ip" "$mac" "$hostname" "$estado"
                done
                local count=$(echo "$resultado" | sort -u -t $'\t' -k1,1 | wc -l)
                echo ""
                echo -e "\e[1;32m✓ Total de clientes conectados: $count\e[0m"
            fi
        fi
        
        echo -e "\n-----------------------------------------------------------------------------------"
        echo -e "\e[1;33m[Presione Enter para volver al menú]\e[0m"
        
        read -t 3 input
        if [ $? -eq 0 ]; then break; fi
    done
}

# --- MENU PRINCIPAL ---
while true; do
    clear
    echo -e "========================================"
    echo -e "        GESTOR DHCP PROFESIONAL"
    echo -e "========================================"
    echo "1) Verificar Estado del Sistema"
    echo "2) Instalación + Configuración de Scope"
    echo "3) Monitoreo de Clientes (Tiempo Real)"
    echo "4) Limpieza Total del Sistema"
    echo "5) Ver Historial de Acciones"
    echo "6) Ver Archivo de Leases Completo"
    echo "7) Diagnóstico Completo"
    echo "8) Salir"
    read -p "Seleccione opción: " opcion

    case $opcion in
        1)
            echo -e "\n\e[1;36m=== ESTADO DEL SISTEMA DHCP ===\e[0m"
            if dpkg -l | grep -q isc-dhcp-server; then
                echo -e "DHCP Server: \e[32m✓ Instalado\e[0m"
                echo -e "Estado: \e[1m$(systemctl is-active isc-dhcp-server 2>/dev/null)\e[0m"
                
                echo -e "\n\e[1;33m--- DETALLES DE CONFIGURACIÓN ---\e[0m"
                # Extraer IP actual de la interfaz
                CURRENT_IP=$(ip -4 addr show $INTERFAZ | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
                
                # Extraer datos del archivo dhcpd.conf si existe
                if [ -f /etc/dhcp/dhcpd.conf ]; then
                    CONF="/etc/dhcp/dhcpd.conf"
                    # Usamos grep y awk para limpiar los datos
                    SUBNET=$(grep "subnet" $CONF | head -1 | awk '{print $2}')
                    RANGE_START=$(grep "range" $CONF | head -1 | awk '{print $2}')
                    RANGE_END=$(grep "range" $CONF | head -1 | awk '{print $3}' | tr -d ';')
                    ROUTER=$(grep "option routers" $CONF | head -1 | awk '{print $3}' | tr -d ';')
                    DNS=$(grep "option domain-name-servers" $CONF | head -1 | cut -d ' ' -f3- | tr -d ';')
                    AMBITO_NAME=$(grep "# AMBITO:" $CONF | cut -d: -f2) 
                    
                    echo -e "Interfaz:        \e[36m$INTERFAZ\e[0m"
                    echo -e "IP Servidor:     \e[36m${CURRENT_IP:-No asignada}\e[0m"
                    echo -e "Nombre Ámbito:   \e[36m${AMBITO_NAME:-Desconocido}\e[0m"
                    echo -e "Segmento de Red: \e[36m${SUBNET:-Desconocido}\e[0m"
                    echo -e "Rango de IPs:    \e[36m${RANGE_START:-N/A} - ${RANGE_END:-N/A}\e[0m"
                    echo -e "Gateway (GW):    \e[36m${ROUTER:-N/A}\e[0m"
                    echo -e "DNS:             \e[36m${DNS:-N/A}\e[0m"
                else
                    echo -e "\e[31mArchivo de configuración no encontrado (/etc/dhcp/dhcpd.conf)\e[0m"
                fi
            else
                echo -e "DHCP Server: \e[31m✗ No instalado\e[0m"
            fi
            read -p "Presione Enter..."
            ;;
        2)
            echo -e "\n\e[1;36m=== INSTALACIÓN Y CONFIGURACIÓN ===\e[0m"
            echo "Instalando componentes..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get update -y -qq > /dev/null 2>&1
            sudo DEBIAN_FRONTEND=noninteractive apt-get install isc-dhcp-server -y -qq > /dev/null 2>&1
            
            echo -e "\n--- CONFIGURACIÓN DEL SCOPE ---"
            read -p "Nombre del Ámbito: " ambito
            
            # --- PEDIR SEGMENTO DE RED ---
            read -p "Segmento de Red (Opcional, Enter para automático): " SEGMENTO_INPUT
            
            read -p "IP del Servidor (Fija): " IPI
            read -p "IP Final del Rango: " IPF
            
            read -p "¿Configurar Gateway? (s/n): " config_gw
            GATEWAY=""
            [[ $config_gw == "s" || $config_gw == "S" ]] && read -p "IP del Gateway: " GATEWAY
            
            read -p "¿Configurar DNS? (s/n): " config_dns
            DNS1=""
            DNS2=""
            if [[ $config_dns == "s" || $config_dns == "S" ]]; then
                read -p "DNS Primario: " DNS1
                read -p "DNS Secundario (opcional): " DNS2
            fi
            
            if validar_ip $IPI && validar_ip $IPF && validar_rango $IPI $IPF; then
                configurar_red_servidor $IPI
                
                # --- LÓGICA DEL SEGMENTO ---
                if [ -z "$SEGMENTO_INPUT" ]; then
                    # Automático: primeros 3 octetos de la IP del servidor
                    SEG_NET=$(echo $IPI | cut -d. -f1-3).0
                    SEG_PREFIX=$(echo $IPI | cut -d. -f1-3)
                else
                    # Manual
                    SEG_NET=$SEGMENTO_INPUT
                    SEG_PREFIX=$(echo $IPI | cut -d. -f1-3) 
                fi
                
                # Calcular inicio del pool (IP Servidor + 1)
                POOL_I="$SEG_PREFIX.$(( $(echo $IPI | cut -d. -f4) + 1 ))"
                
                # CREACION DEL ARCHIVO CONFIGURANDO EL DOMINIO PARA QUE EL CLIENTE VEA SOLO EL SEGMENTO
                CONFIG="# AMBITO:$ambito
authoritative;
default-lease-time 28800;
max-lease-time 28800;

# ESTA LINEA ENVIA SOLO EL NUMERO DE SEGMENTO AL CLIENTE (Sufijo DNS)
option domain-name \"$SEG_NET\";

subnet $SEG_NET netmask 255.255.255.0 {
  range $POOL_I $IPF;"

                [ ! -z "$GATEWAY" ] && validar_ip $GATEWAY && CONFIG="$CONFIG
  option routers $GATEWAY;"
                
                if [ ! -z "$DNS1" ] && validar_ip $DNS1; then
                    DNS_LINE="option domain-name-servers $DNS1"
                    [ ! -z "$DNS2" ] && validar_ip $DNS2 && DNS_LINE="$DNS_LINE, $DNS2"
                    CONFIG="$CONFIG
  $DNS_LINE;"
                fi
                
                CONFIG="$CONFIG
}"

                echo "$CONFIG" | sudo tee /etc/dhcp/dhcpd.conf > /dev/null
                sudo sed -i "s/INTERFACESv4=\".*\"/INTERFACESv4=\"$INTERFAZ\"/" /etc/default/isc-dhcp-server
                
                sudo mkdir -p /var/lib/dhcp
                sudo touch /var/lib/dhcp/dhcpd.leases
                sudo chmod 644 /var/lib/dhcp/dhcpd.leases
                
                sudo systemctl restart isc-dhcp-server
                sleep 2
                
                if systemctl is-active --quiet isc-dhcp-server; then
                    echo -e "\n\e[32m✓ ¡Servidor DHCP configurado correctamente!\e[0m"
                    echo "  - Segmento: $SEG_NET"
                    echo "  - Rango: $POOL_I - $IPF"
                    echo "  - El cliente verá en 'Sufijo DNS': $SEG_NET"
                else
                    echo -e "\n\e[31m✗ Error al iniciar el servicio\e[0m"
                    echo "Verifique que la IP del servidor ($IPI) pertenezca al segmento ($SEG_NET)"
                fi
                registrar_log "Scope: $ambito. Segmento: $SEG_NET. Rango: $POOL_I-$IPF"
            else
                echo -e "\e[31m✗ Error: IPs inválidas\e[0m"
            fi
            sleep 3
            ;;
        3) 
            monitoreo_activo
            ;;
        4)
            echo -e "\e[33mEliminando sistema DHCP...\e[0m"
            sudo systemctl stop isc-dhcp-server > /dev/null 2>&1
            sudo apt-get purge isc-dhcp-server -y -qq > /dev/null 2>&1
            sudo apt-get autoremove -y -qq > /dev/null 2>&1
            sudo rm -rf /etc/dhcp /var/lib/dhcp /var/lib/dhcpd
            registrar_log "Sistema eliminado completamente"
            echo -e "\e[32m✓ Limpieza completada\e[0m"
            sleep 2
            ;;
        5)
            clear
            echo -e "\e[1;36m=== HISTORIAL DE ACCIONES ===\e[0m"
            [ -f "$LOG_HISTORIAL" ] && tail -n 25 "$LOG_HISTORIAL" || echo "Sin registros"
            read -p "Presione Enter..."
            ;;
        6)
            clear
            echo -e "\e[1;36m=== ARCHIVO DE LEASES COMPLETO ===\e[0m"
            local lf="/var/lib/dhcp/dhcpd.leases"
            [ ! -f "$lf" ] && lf="/var/lib/dhcpd/dhcpd.leases"
            [ -f "$lf" ] && sudo cat "$lf" || echo "Archivo no encontrado"
            read -p "Presione Enter..."
            ;;
        7)
            clear
            echo -e "\e[1;36m=== DIAGNÓSTICO COMPLETO ===\e[0m\n"
            echo "1. SERVICIO:"
            systemctl status isc-dhcp-server --no-pager 2>/dev/null | head -15 || echo "No instalado"
            echo -e "\n2. RED ($INTERFAZ):"
            ip addr show $INTERFAZ 2>/dev/null || echo "Interfaz no encontrada"
            echo -e "\n3. CONFIGURACIÓN:"
            [ -f /etc/dhcp/dhcpd.conf ] && sudo cat /etc/dhcp/dhcpd.conf || echo "No existe"
            read -p "Presione Enter..."
            ;;
        8) 
            echo "Saliendo..."
            exit 0
            ;;
        *)
            echo -e "\e[31m✗ Opción inválida\e[0m"
            sleep 1
            ;;
    esac
done
