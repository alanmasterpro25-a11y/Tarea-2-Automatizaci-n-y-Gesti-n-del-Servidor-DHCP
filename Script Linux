#!/bin/bash

# Archivo de registro persistente (No se borra con la opci√≥n 4)
LOG_HISTORIAL="/var/log/dhcp_gestion_acciones.log"

# Funci√≥n para guardar historial
registrar_log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | sudo tee -a "$LOG_HISTORIAL" > /dev/null
}

# 1. Validaciones
validar_ip() {
    [[ $1 =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]] || return 1
}

validar_rango() {
    local r1=$(echo $1 | cut -d. -f1-3); local r2=$(echo $2 | cut -d. -f1-3)
    [ "$r1" == "$r2" ] && [ $(echo $1 | cut -d. -f4) -lt $(echo $2 | cut -d. -f4) ]
}

# 2. Configuraci√≥n de Red
configurar_red_servidor() {
    local ip=$1
    local iface="ens34"
    sudo ip addr flush dev $iface
    sudo ip addr add $ip/24 dev $iface
    sudo ip link set $iface up
    registrar_log "IP Est√°tica configurada: $ip en $iface"
}

# 3. Monitoreo INTELIGENTE - Detecta clientes bas√°ndose en si NO est√°n "free"
monitoreo_activo() {
    echo -e "\e[33mIniciando monitoreo en tiempo real...\e[0m"
    echo -e "\e[33mPresione Enter en cualquier momento para volver al men√∫\e[0m"
    sleep 2
    
    # Buscar archivo de leases
    local leases_file=""
    local posibles_leases=(
        "/var/lib/dhcp/dhcpd.leases"
        "/var/lib/dhcpd/dhcpd.leases"
        "/var/db/dhcpd/dhcpd.leases"
    )
    
    for file in "${posibles_leases[@]}"; do
        if [ -f "$file" ]; then
            leases_file="$file"
            break
        fi
    done
    
    # Loop de monitoreo
    while true; do
        clear
        echo -e "\e[34m=========================================================="
        echo -e "           SISTEMA DE MONITOREO DE RED ACTIVA"
        echo -e "           (Actualizaci√≥n autom√°tica cada 3 segundos)"
        echo -e "==========================================================\e[0m"
        echo -e "\e[1mIP CLIENTE\t\tMAC ADDRESS\t\tHOSTNAME\t\tESTADO\e[0m"
        echo "-----------------------------------------------------------------------------------"

        if [ -z "$leases_file" ] || [ ! -f "$leases_file" ]; then
            echo -e "\e[31mERROR: Archivo de concesiones no encontrado\e[0m"
        elif [ ! -s "$leases_file" ]; then
            echo -e "\e[33mEsperando conexiones... (Archivo vac√≠o)\e[0m"
        else
            # NUEVA L√ìGICA: Mostrar solo IPs que NO est√©n "free"
            # Si un cliente hace release, su estado cambia a "free" y desaparece
            # Si est√° conectado, tendr√° cualquier otro estado (active, state, etc.)
            
            resultado=$(sudo awk '
                /^lease / { 
                    ip = $2
                }
                /binding state/ { 
                    st = $3
                    gsub(";","",st)
                    estado_temp = st
                }
                /hardware ethernet/ { 
                    mac = $3
                    gsub(";","",mac)
                    mac_temp = mac
                }
                /client-hostname/ { 
                    h = $2
                    gsub("[\";]","",h)
                    host_temp = (h != "") ? h : "Desconocido"
                }
                /^}/ {
                    # Guardar datos (√∫ltima entrada gana)
                    if (ip != "") {
                        estado[ip] = estado_temp
                        macs[ip] = mac_temp
                        host[ip] = host_temp
                    }
                    # Reset
                    ip = ""
                    estado_temp = ""
                    mac_temp = "N/A"
                    host_temp = "Desconocido"
                }
                END {
                    # Mostrar SOLO las que NO sean "free"
                    for (i in estado) {
                        if (estado[i] != "free") {
                            printf "%s\t%s\t%s\tCONECTADO\n", i, macs[i], host[i]
                        }
                    }
                }
            ' "$leases_file")
            
            if [ -z "$resultado" ]; then
                echo -e "\e[33mNo hay clientes conectados actualmente.\e[0m"
                echo -e "\e[90m(Clientes que hicieron 'ipconfig /release' no se muestran)\e[0m"
                echo ""
                echo -e "\e[36müìã Historial de IPs:\e[0m"
                sudo awk '
                    /^lease / { ip=$2 }
                    /binding state/ { st=$3; gsub(";","",st); estado[ip]=st }
                    /^}/ { 
                        if(ip!="" && estado[ip]!="") { 
                            if(estado[ip]=="free") 
                                print "  \033[90m"ip" (liberada - ipconfig /release)\033[0m"
                            else 
                                print "  \033[33m"ip" (estado: "estado[ip]")\033[0m"
                            ip=""; estado[ip]="" 
                        } 
                    }
                ' "$leases_file" | sort -u
            else
                echo -e "\n\e[1;32m=== CLIENTES CONECTADOS ===\e[0m"
                echo "$resultado" | sort -u -t $'\t' -k1,1 | while IFS=$'\t' read -r ip mac hostname estado; do
                    printf "\e[32m‚úì %-16s %-20s %-20s %s\e[0m\n" "$ip" "$mac" "$hostname" "$estado"
                done
                
                local count=$(echo "$resultado" | sort -u -t $'\t' -k1,1 | wc -l)
                echo ""
                echo -e "\e[1;32m‚úì Total de clientes conectados: $count\e[0m"
            fi
            
            # Mostrar ARP
            echo -e "\n\e[1;35m=== DISPOSITIVOS EN LA RED (ARP) ===\e[0m"
            local arp_output=$(sudo arp -n 2>/dev/null | grep -v "incomplete" | grep "ens34")
            if [ ! -z "$arp_output" ]; then
                echo "$arp_output" | awk '{print "  "$1"\t"$3}' | head -10
            else
                echo -e "  \e[90mNo hay dispositivos en la tabla ARP para ens34\e[0m"
            fi
        fi
        
        echo -e "\n-----------------------------------------------------------------------------------"
        echo -e "\e[36mEstad√≠sticas del servidor:\e[0m"
        echo -e "  - Servicio DHCP: \e[1m$(systemctl is-active isc-dhcp-server 2>/dev/null || echo 'inactivo')\e[0m"
        echo -e "  - Archivo leases: ${leases_file:-'NO ENCONTRADO'}"
        if [ -f "$leases_file" ]; then
            echo -e "  - Tama√±o: $(sudo ls -lh "$leases_file" 2>/dev/null | awk '{print $5}')"
            echo -e "  - Modificado: $(sudo stat -c %y "$leases_file" 2>/dev/null | cut -d'.' -f1)"
        fi
        echo -e "\n\e[1;33m[Presione Enter para volver al men√∫]\e[0m"
        
        # Esperar 3 segundos O Enter
        read -t 3 input
        if [ $? -eq 0 ]; then
            break
        fi
    done
}

# --- MENU PRINCIPAL ---
while true; do
    clear
    echo -e "========================================"
    echo -e "       GESTOR DHCP PROFESIONAL"
    echo -e "========================================"
    echo "1) Verificar Estado del Sistema"
    echo "2) Instalaci√≥n + Configuraci√≥n de Scope"
    echo "3) Monitoreo de Clientes (Tiempo Real)"
    echo "4) Limpieza Total del Sistema"
    echo "5) Ver Historial de Acciones"
    echo "6) Ver Archivo de Leases Completo"
    echo "7) Diagn√≥stico Completo"
    echo "8) Salir"
    read -p "Seleccione opci√≥n: " opcion

    case $opcion in
        1)
            echo -e "\n\e[1;36m=== ESTADO DEL SISTEMA DHCP ===\e[0m"
            if dpkg -l | grep -q isc-dhcp-server; then
                echo -e "DHCP Server: \e[32m‚úì Instalado\e[0m"
                echo -e "Estado: \e[1m$(systemctl is-active isc-dhcp-server 2>/dev/null)\e[0m"
                echo -e "Habilitado: $(systemctl is-enabled isc-dhcp-server 2>/dev/null || echo 'disabled')"
                echo -e "\n\e[1mConfiguraci√≥n actual:\e[0m"
                [ -f /etc/dhcp/dhcpd.conf ] && sudo cat /etc/dhcp/dhcpd.conf | grep -v "^#" | grep -v "^$" || echo "No configurado"
                echo -e "\n\e[1mArchivo de leases:\e[0m"
                ls -lh /var/lib/dhcp/dhcpd.leases 2>/dev/null || ls -lh /var/lib/dhcpd/dhcpd.leases 2>/dev/null || echo "No encontrado"
            else
                echo -e "DHCP Server: \e[31m‚úó No instalado\e[0m"
            fi
            read -p "Presione Enter..."
            ;;
        2)
            echo -e "\n\e[1;36m=== INSTALACI√ìN Y CONFIGURACI√ìN ===\e[0m"
            echo "Instalando componentes..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get update -y -qq > /dev/null 2>&1
            sudo DEBIAN_FRONTEND=noninteractive apt-get install isc-dhcp-server -y -qq > /dev/null 2>&1
            
            echo -e "\n--- CONFIGURACI√ìN DEL SCOPE ---"
            read -p "Nombre del √Åmbito: " ambito
            read -p "IP del Servidor (Fija): " IPI
            read -p "IP Final del Rango: " IPF
            
            read -p "¬øConfigurar Gateway? (s/n): " config_gw
            GATEWAY=""
            [[ $config_gw == "s" || $config_gw == "S" ]] && read -p "IP del Gateway: " GATEWAY
            
            read -p "¬øConfigurar DNS? (s/n): " config_dns
            DNS1=""
            DNS2=""
            if [[ $config_dns == "s" || $config_dns == "S" ]]; then
                read -p "DNS Primario: " DNS1
                read -p "DNS Secundario (opcional): " DNS2
            fi
            
            if validar_ip $IPI && validar_ip $IPF && validar_rango $IPI $IPF; then
                configurar_red_servidor $IPI
                SEG=$(echo $IPI | cut -d. -f1-3)
                POOL_I="$SEG.$(( $(echo $IPI | cut -d. -f4) + 1 ))"
                
                CONFIG="authoritative;
default-lease-time 28800;
max-lease-time 28800;

subnet $SEG.0 netmask 255.255.255.0 {
  range $POOL_I $IPF;"

                [ ! -z "$GATEWAY" ] && validar_ip $GATEWAY && CONFIG="$CONFIG
  option routers $GATEWAY;"
                
                if [ ! -z "$DNS1" ] && validar_ip $DNS1; then
                    if [ ! -z "$DNS2" ] && validar_ip $DNS2; then
                        CONFIG="$CONFIG
  option domain-name-servers $DNS1, $DNS2;"
                    else
                        CONFIG="$CONFIG
  option domain-name-servers $DNS1;"
                    fi
                fi
                
                CONFIG="$CONFIG
}"

                echo "$CONFIG" | sudo tee /etc/dhcp/dhcpd.conf > /dev/null
                sudo sed -i 's/INTERFACESv4=\".*\"/INTERFACESv4=\"ens34\"/' /etc/default/isc-dhcp-server
                
                sudo mkdir -p /var/lib/dhcp
                sudo touch /var/lib/dhcp/dhcpd.leases
                sudo chmod 644 /var/lib/dhcp/dhcpd.leases
                
                sudo systemctl restart isc-dhcp-server
                sleep 2
                
                if systemctl is-active --quiet isc-dhcp-server; then
                    echo -e "\n\e[32m‚úì ¬°Servidor DHCP configurado correctamente!\e[0m"
                    echo -e "\nConfiguraci√≥n:"
                    echo "  - Rango: $POOL_I - $IPF"
                    [ ! -z "$GATEWAY" ] && echo "  - Gateway: $GATEWAY"
                    [ ! -z "$DNS1" ] && echo "  - DNS: $DNS1$([ ! -z "$DNS2" ] && echo ", $DNS2")"
                else
                    echo -e "\n\e[31m‚úó Error al iniciar el servicio\e[0m"
                    echo "Ver logs: sudo journalctl -u isc-dhcp-server -n 20"
                fi
                
                registrar_log "Scope: $ambito. Rango: $POOL_I-$IPF. GW: ${GATEWAY:-N/A}. DNS: ${DNS1:-N/A}"
            else
                echo -e "\e[31m‚úó Error: IPs inv√°lidas\e[0m"
            fi
            sleep 3
            ;;
        3) 
            monitoreo_activo
            ;;
        4)
            echo -e "\e[33mEliminando sistema DHCP...\e[0m"
            sudo systemctl stop isc-dhcp-server > /dev/null 2>&1
            sudo apt-get purge isc-dhcp-server -y -qq > /dev/null 2>&1
            sudo apt-get autoremove -y -qq > /dev/null 2>&1
            sudo rm -rf /etc/dhcp /var/lib/dhcp /var/lib/dhcpd
            registrar_log "Sistema eliminado completamente"
            echo -e "\e[32m‚úì Limpieza completada\e[0m"
            sleep 2
            ;;
        5)
            clear
            echo -e "\e[1;36m=== HISTORIAL DE ACCIONES ===\e[0m"
            [ -f "$LOG_HISTORIAL" ] && tail -n 25 "$LOG_HISTORIAL" || echo "Sin registros"
            read -p "Presione Enter..."
            ;;
        6)
            clear
            echo -e "\e[1;36m=== ARCHIVO DE LEASES COMPLETO ===\e[0m"
            local lf="/var/lib/dhcp/dhcpd.leases"
            [ ! -f "$lf" ] && lf="/var/lib/dhcpd/dhcpd.leases"
            
            if [ -f "$lf" ]; then
                sudo cat "$lf"
                echo -e "\n\e[1m--- RESUMEN ---\e[0m"
                echo "Total leases: $(sudo grep -c '^lease' "$lf")"
                echo "Estados:"
                sudo grep 'binding state' "$lf" | awk '{print $3}' | sort | uniq -c
            else
                echo "Archivo no encontrado"
            fi
            read -p "Presione Enter..."
            ;;
        7)
            clear
            echo -e "\e[1;36m=== DIAGN√ìSTICO COMPLETO ===\e[0m\n"
            echo "1. SERVICIO:"
            systemctl status isc-dhcp-server --no-pager 2>/dev/null | head -15 || echo "No instalado"
            echo -e "\n2. RED (ens34):"
            ip addr show ens34 2>/dev/null || echo "Interfaz no encontrada"
            echo -e "\n3. CONFIGURACI√ìN:"
            [ -f /etc/dhcp/dhcpd.conf ] && sudo cat /etc/dhcp/dhcpd.conf || echo "No existe"
            echo -e "\n4. LOGS (√∫ltimos 10):"
            sudo journalctl -u isc-dhcp-server -n 10 --no-pager 2>/dev/null || echo "No disponible"
            read -p "Presione Enter..."
            ;;
        8) 
            echo "Saliendo..."
            exit 0
            ;;
        *)
            echo -e "\e[31m‚úó Opci√≥n inv√°lida\e[0m"
            sleep 1
            ;;
    esac
done
