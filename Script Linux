#!/bin/bash

# =========================================================
# SCRIPT DE ADMINISTRACION DHCP - FIJO PARA ENS34
# =========================================================

# --- FUNCIONES DE VALIDACION ---

validar_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]]; then
        return 0
    else
        return 1
    fi
}

validar_segmento_orden() {
    local ip1=$1
    local ip2=$2
    local red1=$(echo $ip1 | cut -d. -f1-3)
    local red2=$(echo $ip2 | cut -d. -f2-4) # Error corregido en corte para comparacion
    red2=$(echo $ip2 | cut -d. -f1-3)
    
    local host1=$(echo $ip1 | cut -d. -f4)
    local host2=$(echo $ip2 | cut -d. -f4)

    if [ "$red1" != "$red2" ]; then
        echo -e "\e[31m[ERROR] Las IPs no pertenecen al mismo segmento ($red1 vs $red2).\e[0m"
        return 1
    fi

    if [ "$host1" -ge "$host2" ]; then
        echo -e "\e[31m[ERROR] La IP Inicial ($host1) debe ser menor a la Final ($host2).\e[0m"
        return 1
    fi
    return 0
}

# --- MENU PRINCIPAL ---

while true; do
    echo ""
    echo "========================================"
    echo "    MENU GESTION DHCP (FIJO: ENS34)"
    echo "========================================"
    echo "1) Verificar Instalacion"
    echo "2) Instalacion / Configurar (Silenciosa)"
    echo "3) Monitoreo (Ver IPs Asignadas)"
    echo "4) Desinstalar / Limpiar Servicio"
    echo "5) Salir"
    read -p "Elija una opcion: " opcion

    case $opcion in
        1)
            if dpkg -l | grep -q isc-dhcp-server; then
                echo -e "\e[32m[ESTADO] Servicio DHCP instalado y detectado.\e[0m"
            else
                echo -e "\e[33m[ESTADO] Servicio NO instalado (Maquina Limpia).\e[0m"
            fi
            ;;
        2)
            # Definimos la interfaz fija para tu practica
            IFACE="ens34"

            if ! dpkg -l | grep -q isc-dhcp-server; then
                echo "Instalando isc-dhcp-server..."
                sudo apt-get update -qq && sudo apt-get install isc-dhcp-server -y -qq
            fi

            read -p "Ingrese IP Inicial: " IPI
            read -p "Ingrese IP Final: " IPF

            if validar_ip $IPI && validar_ip $IPF; then
                if validar_segmento_orden $IPI $IPF; then
                    NETWORK=$(echo $IPI | cut -d. -f1-3).0
                    MASK="255.255.255.0"
                    
                    # 1. Configurar el archivo dhcpd.conf
                    sudo bash -c "cat <<EOF > /etc/dhcp/dhcpd.conf
authoritative;
subnet $NETWORK netmask $MASK {
  range $IPI $IPF;
  option routers $(echo $IPI | cut -d. -f1-3).1;
  option domain-name-servers 192.168.100.20;
}
EOF"
                    # 2. Forzar al servidor a escuchar SOLO en ens34
                    sudo sed -i "s/INTERFACESv4=\".*\"/INTERFACESv4=\"$IFACE\"/" /etc/default/isc-dhcp-server

                    # 3. Reiniciar el servicio
                    sudo systemctl restart isc-dhcp-server
                    echo -e "\e[32mConfiguracion aplicada exitosamente en la interfaz $IFACE.\e[0m"
                fi
            else
                echo -e "\e[31mError: Formato de IP invalido.\e[0m"
            fi
            ;;
        3)
            echo "--- MONITOR DE CONCESIONES (Leases) ---"
            # Muestra las IPs que el servidor ha entregado
            sudo grep "lease" /var/lib/dhcp/dhcpd.leases | sort | uniq
            ;;
        4)
            echo "Desinstalando y purgando configuraciones..."
            sudo systemctl stop isc-dhcp-server
            sudo apt-get purge isc-dhcp-server -y -qq
            sudo rm -rf /etc/dhcp
            echo -e "\e[33mSistema limpio. Servicio eliminado.\e[0m"
            ;;
        5) exit ;;
        *) echo "Opcion no valida." ;;
    esac
done
